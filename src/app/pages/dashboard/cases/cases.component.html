<!-- Header -->
<header class="bg-slate-800 border-b border-slate-700 sticky top-14 lg:top-0 z-10">
  <div class="px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-14 md:h-16">
      <div class="min-w-0">
        <h1 class="text-lg md:text-xl font-semibold text-slate-100 truncate">Cases</h1>
        <p class="text-xs md:text-sm text-slate-400 hidden sm:block">Case submissions & purchases</p>
      </div>

      <div class="flex items-center space-x-2 md:space-x-4 flex-shrink-0">
        @if (lastRefreshed) {
          <span class="text-xs text-slate-500 hidden sm:inline">
            {{ lastRefreshed | date:'shortTime' }}
          </span>
        }
        <button
          (click)="refreshAll()"
          [disabled]="isRefreshing"
          class="btn-secondary flex items-center"
        >
          <svg
            class="w-4 h-4 md:mr-2"
            [class.animate-spin]="isRefreshing"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <span class="hidden md:inline">{{ isRefreshing ? 'Refreshing...' : 'Refresh' }}</span>
        </button>
      </div>
    </div>
  </div>
</header>

<!-- Content -->
<div class="p-4 sm:p-6 lg:p-8">
  <!-- Period Selector -->
  <div class="mb-6">
    <div class="flex flex-wrap gap-2">
      @for (period of periods; track period.value) {
        <button
          (click)="setPeriod(period.value)"
          [class]="selectedPeriod === period.value
            ? 'bg-indigo-500 text-white'
            : 'bg-slate-700 text-slate-300 hover:bg-slate-600'"
          class="px-4 py-2 rounded-lg text-sm font-medium transition-colors"
        >
          {{ period.label }}
        </button>
      }
    </div>
  </div>

  @if (isLoading) {
    <!-- Loading State -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      @for (i of [1, 2, 3, 4]; track i) {
        <div class="card">
          <app-loading-skeleton height="80px"></app-loading-skeleton>
        </div>
      }
    </div>
    <div class="card">
      <div class="space-y-4">
        @for (i of [1, 2, 3, 4, 5]; track i) {
          <app-loading-skeleton height="60px"></app-loading-skeleton>
        }
      </div>
    </div>
  } @else if (error) {
    <!-- Error State -->
    <div class="card text-center py-8">
      <svg class="w-12 h-12 mx-auto text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <p class="text-red-500 mb-2">{{ error }}</p>
      <button (click)="loadData()" class="text-indigo-400 hover:text-indigo-300 underline text-sm">
        Retry
      </button>
    </div>
  } @else {
    <!-- Stats Cards -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <app-metric-card
        title="Total Cases"
        [value]="supabaseData?.totalCases || 0"
      ></app-metric-card>

      <app-metric-card
        title="Quick Previews"
        [value]="supabaseData?.quickPreviewCompletions || 0"
      ></app-metric-card>

      <app-metric-card
        title="Full Previews"
        [value]="supabaseData?.fullPreviewCompletions || 0"
      ></app-metric-card>

      <app-metric-card
        title="Purchases"
        [value]="supabaseData?.purchases || 0"
      ></app-metric-card>
    </div>

    <!-- Revenue & Conversion Metrics -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="card">
        <p class="text-xs text-slate-400 mb-1">Total Revenue</p>
        <p class="text-2xl font-bold text-green-400">${{ supabaseData?.totalRevenue || 0 | number:'1.2-2' }}</p>
        <p class="text-xs text-slate-500 mt-1">From purchases</p>
      </div>

      <div class="card">
        <p class="text-xs text-slate-400 mb-1">Revenue per Case</p>
        <p class="text-2xl font-bold text-slate-100">${{ getRevenuePerVisitor() | number:'1.2-2' }}</p>
        <p class="text-xs text-slate-500 mt-1">Total Rev / Cases</p>
      </div>

      <div class="card">
        <p class="text-xs text-slate-400 mb-1">Avg Purchase Value</p>
        <p class="text-2xl font-bold text-indigo-400">${{ getAvgCaseValue() | number:'1.2-2' }}</p>
        <p class="text-xs text-slate-500 mt-1">Rev / Purchases</p>
      </div>

      <div class="card">
        <p class="text-xs text-slate-400 mb-1">Overall Conversion</p>
        <p class="text-2xl font-bold" [class]="(supabaseData?.funnel?.overallConversionRate || 0) > 5 ? 'text-green-400' : 'text-yellow-400'">
          {{ supabaseData?.funnel?.overallConversionRate || 0 }}%
        </p>
        <p class="text-xs text-slate-500 mt-1">Cases to Purchase</p>
      </div>
    </div>

    <!-- Funnel Analysis -->
    <section class="mb-8">
      <h2 class="section-header">Conversion Funnel</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Funnel Steps -->
        <div class="card">
          <h3 class="text-sm font-medium text-slate-300 mb-4">Funnel Progression</h3>
          <div class="space-y-4">
            <!-- Quick Preview Stage -->
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-slate-300">Quick Preview</span>
                <span class="text-slate-100">{{ supabaseData?.quickPreviewCompletions || 0 }}</span>
              </div>
              <div class="h-3 bg-slate-700 rounded-full overflow-hidden">
                <div class="h-full bg-blue-500 rounded-full" style="width: 100%"></div>
              </div>
            </div>

            <!-- Full Preview Stage -->
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-slate-300">Full Preview</span>
                <span class="text-slate-100">{{ supabaseData?.fullPreviewCompletions || 0 }}</span>
              </div>
              <div class="h-3 bg-slate-700 rounded-full overflow-hidden">
                <div class="h-full bg-indigo-500 rounded-full"
                  [style.width.%]="(supabaseData?.quickPreviewCompletions || 0) > 0 ? ((supabaseData?.fullPreviewCompletions || 0) / (supabaseData?.quickPreviewCompletions || 1)) * 100 : 0">
                </div>
              </div>
              <p class="text-xs text-slate-500 mt-1">{{ supabaseData?.funnel?.quickToFullPreviewRate || 0 }}% conversion</p>
            </div>

            <!-- Purchase Stage -->
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-slate-300">Purchased</span>
                <span class="text-slate-100">{{ supabaseData?.purchases || 0 }}</span>
              </div>
              <div class="h-3 bg-slate-700 rounded-full overflow-hidden">
                <div class="h-full bg-green-500 rounded-full"
                  [style.width.%]="(supabaseData?.quickPreviewCompletions || 0) > 0 ? ((supabaseData?.purchases || 0) / (supabaseData?.quickPreviewCompletions || 1)) * 100 : 0">
                </div>
              </div>
              <p class="text-xs text-slate-500 mt-1">{{ supabaseData?.funnel?.fullPreviewToPurchaseRate || 0 }}% conversion</p>
            </div>
          </div>
        </div>

        <!-- Drop-off Analysis -->
        <div class="card">
          <h3 class="text-sm font-medium text-slate-300 mb-4">Drop-off Analysis</h3>
          <div class="space-y-4">
            <div class="p-3 bg-amber-500/10 border border-amber-500/30 rounded-lg">
              <div class="flex justify-between items-center">
                <div>
                  <p class="text-slate-300 font-medium">Quick → Full Preview</p>
                  <p class="text-xs text-slate-500">Users not progressing</p>
                </div>
                <p class="text-2xl font-bold text-amber-400">{{ getQuickToFullDropoff() | number:'1.1-1' }}%</p>
              </div>
            </div>

            <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
              <div class="flex justify-between items-center">
                <div>
                  <p class="text-slate-300 font-medium">Full Preview → Purchase</p>
                  <p class="text-xs text-slate-500">Users not converting</p>
                </div>
                <p class="text-2xl font-bold text-red-400">{{ getFullToPurchaseDropoff() | number:'1.1-1' }}%</p>
              </div>
            </div>

            <!-- Notice Type Distribution -->
            @if (getNoticeTypeDistribution().length > 0) {
              <div class="border-t border-slate-700 pt-4">
                <h4 class="text-xs font-medium text-slate-400 mb-3">Top Notice Types</h4>
                <div class="space-y-2">
                  @for (item of getNoticeTypeDistribution(); track item.type) {
                    <div class="flex items-center gap-2">
                      <div class="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden">
                        <div class="h-full bg-indigo-500 rounded-full" [style.width.%]="getNoticeTypePercentage(item.count)"></div>
                      </div>
                      <span class="text-xs text-slate-300 w-24 truncate capitalize">{{ item.type }}</span>
                      <span class="text-xs text-slate-400 w-8 text-right">{{ item.count }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    </section>

    <!-- Cases Table -->
    <section>
      <div class="flex items-center justify-between mb-4">
        <h2 class="section-header mb-0">Recent Cases</h2>
        <!-- Filter Tabs -->
        <div class="flex gap-1 bg-slate-800 rounded-lg p-1">
          @for (filter of filters; track filter.value) {
            <button
              (click)="setFilter(filter.value)"
              [class]="selectedFilter === filter.value
                ? 'bg-slate-700 text-slate-100'
                : 'text-slate-400 hover:text-slate-300'"
              class="px-3 py-1.5 rounded text-xs font-medium transition-colors"
            >
              {{ filter.label }}
            </button>
          }
        </div>
      </div>

      <div class="card">
        @if (filteredCases.length === 0) {
          <div class="text-center py-8">
            <svg class="w-12 h-12 mx-auto text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p class="text-slate-400">No cases found for this filter</p>
          </div>
        } @else {
          <!-- Mobile Card Layout -->
          <div class="lg:hidden space-y-3">
            @for (caseItem of filteredCases; track caseItem.id) {
              <div class="bg-slate-700/30 rounded-lg p-4 border border-slate-700/50">
                <div class="flex items-start justify-between mb-3">
                  <div class="min-w-0 flex-1">
                    <p class="text-sm font-medium text-slate-100 truncate">{{ caseItem.email || 'N/A' }}</p>
                    <p class="text-xs text-slate-400 mt-0.5">{{ formatDate(caseItem.created_at) }}</p>
                  </div>
                  <span
                    class="px-2 py-1 rounded-full text-xs border ml-2 flex-shrink-0"
                    [class]="getStatusClass(caseItem)"
                  >
                    {{ getStatusLabel(caseItem) }}
                  </span>
                </div>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-slate-400">Notice Type</span>
                    <span class="text-slate-200">{{ caseItem.noticeType || 'N/A' }}</span>
                  </div>
                  @if (caseItem.issueText) {
                    <div>
                      <span class="text-slate-400 text-xs">Issue</span>
                      <p class="text-slate-300 text-xs mt-0.5 line-clamp-2">{{ caseItem.issueText }}</p>
                    </div>
                  }
                  <div class="flex justify-between pt-2 border-t border-slate-600/50">
                    <span class="text-slate-400">Amount</span>
                    <span class="font-medium" [class]="caseItem.amount ? 'text-green-400' : 'text-slate-500'">
                      @if (caseItem.amount) {
                        ${{ caseItem.amount | number:'1.2-2' }}
                      } @else {
                        -
                      }
                    </span>
                  </div>
                </div>
              </div>
            }
          </div>

          <!-- Desktop Table Layout -->
          <div class="hidden lg:block overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-slate-400 text-left border-b border-slate-700">
                  <th class="pb-3 font-medium">Date</th>
                  <th class="pb-3 font-medium">Email</th>
                  <th class="pb-3 font-medium">Notice Type</th>
                  <th class="pb-3 font-medium">Issue</th>
                  <th class="pb-3 font-medium text-center">Status</th>
                  <th class="pb-3 font-medium text-right">Amount</th>
                </tr>
              </thead>
              <tbody>
                @for (caseItem of filteredCases; track caseItem.id) {
                  <tr class="border-t border-slate-700/50 hover:bg-slate-700/30 transition-colors">
                    <td class="py-3 text-slate-300">
                      {{ formatDate(caseItem.created_at) }}
                    </td>
                    <td class="py-3 text-slate-100">
                      {{ caseItem.email || 'N/A' }}
                    </td>
                    <td class="py-3 text-slate-300">
                      {{ caseItem.noticeType || 'N/A' }}
                    </td>
                    <td class="py-3 text-slate-400 max-w-[200px]" [title]="caseItem.issueText || ''">
                      {{ truncateText(caseItem.issueText) }}
                    </td>
                    <td class="py-3 text-center">
                      <span
                        class="px-2 py-1 rounded-full text-xs border"
                        [class]="getStatusClass(caseItem)"
                      >
                        {{ getStatusLabel(caseItem) }}
                      </span>
                    </td>
                    <td class="py-3 text-right font-medium"
                      [class]="caseItem.amount ? 'text-green-400' : 'text-slate-500'"
                    >
                      @if (caseItem.amount) {
                        ${{ caseItem.amount | number:'1.2-2' }}
                      } @else {
                        -
                      }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Summary Footer -->
          <div class="mt-4 pt-4 border-t border-slate-700 flex items-center justify-between text-sm">
            <span class="text-slate-400">
              Showing {{ filteredCases.length }} of {{ supabaseData?.recentCases?.length || 0 }} cases
            </span>
            @if (supabaseData?.totalRevenue) {
              <span class="text-slate-300">
                Total Revenue: <span class="font-bold text-green-400">${{ supabaseData?.totalRevenue | number:'1.2-2' }}</span>
              </span>
            }
          </div>
        }
      </div>
    </section>

    <!-- Completed/Paid Cases Section -->
    @if ((supabaseData?.completedCases?.length || 0) > 0) {
      <section class="mt-8">
        <h2 class="section-header">Paid Cases & Output Status</h2>

        <!-- Output Stats Summary -->
        @if (supabaseData?.outputStats) {
          <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <div class="card">
              <p class="text-xs text-slate-400 mb-1">Total Paid</p>
              <p class="text-2xl font-bold text-slate-100">{{ supabaseData?.outputStats?.total || 0 }}</p>
            </div>
            <div class="card">
              <p class="text-xs text-slate-400 mb-1">Ready</p>
              <p class="text-2xl font-bold text-green-400">{{ supabaseData?.outputStats?.ready || 0 }}</p>
            </div>
            <div class="card">
              <p class="text-xs text-slate-400 mb-1">Processing</p>
              <p class="text-2xl font-bold text-yellow-400">{{ supabaseData?.outputStats?.pending || 0 }}</p>
            </div>
            <div class="card">
              <p class="text-xs text-slate-400 mb-1">Errors</p>
              <p class="text-2xl font-bold text-red-400">{{ supabaseData?.outputStats?.error || 0 }}</p>
            </div>
            <div class="card">
              <p class="text-xs text-slate-400 mb-1">Success Rate</p>
              <p class="text-2xl font-bold" [class]="getOutputSuccessRate() >= 90 ? 'text-green-400' : getOutputSuccessRate() >= 70 ? 'text-yellow-400' : 'text-red-400'">
                {{ getOutputSuccessRate() | number:'1.0-0' }}%
              </p>
            </div>
          </div>
        }

        <div class="card">
          <!-- Mobile Card Layout -->
          <div class="lg:hidden space-y-3">
            @for (caseItem of supabaseData?.completedCases; track caseItem.id) {
              <div class="bg-slate-700/30 rounded-lg p-4 border border-slate-700/50">
                <div class="flex items-start justify-between mb-3">
                  <div class="min-w-0 flex-1">
                    <p class="text-sm font-medium text-slate-100 truncate">{{ caseItem.email || 'N/A' }}</p>
                    <p class="text-xs text-slate-400 mt-0.5">{{ formatDate(caseItem.created_at) }}</p>
                  </div>
                  <span
                    class="px-2 py-1 rounded-full text-xs border ml-2 flex-shrink-0"
                    [class]="getOutputStatusClass(caseItem.outputStatus)"
                  >
                    {{ getOutputStatusLabel(caseItem.outputStatus) }}
                  </span>
                </div>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-slate-400">Notice Type</span>
                    <span class="text-slate-200 capitalize">{{ caseItem.noticeType || 'N/A' }}</span>
                  </div>
                  @if (caseItem.outputModel) {
                    <div class="flex justify-between">
                      <span class="text-slate-400">Model</span>
                      <span class="text-slate-200">{{ caseItem.outputModel }}</span>
                    </div>
                  }
                  <div class="flex justify-between pt-2 border-t border-slate-600/50">
                    <span class="text-slate-400">Amount Paid</span>
                    <span class="font-medium text-green-400">${{ caseItem.amount || 0 | number:'1.2-2' }}</span>
                  </div>
                </div>
              </div>
            }
          </div>

          <!-- Desktop Table Layout -->
          <div class="hidden lg:block overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-slate-400 text-left border-b border-slate-700">
                  <th class="pb-3 font-medium">Date</th>
                  <th class="pb-3 font-medium">Email</th>
                  <th class="pb-3 font-medium">Notice Type</th>
                  <th class="pb-3 font-medium">Model</th>
                  <th class="pb-3 font-medium text-center">Output Status</th>
                  <th class="pb-3 font-medium text-right">Amount</th>
                </tr>
              </thead>
              <tbody>
                @for (caseItem of supabaseData?.completedCases; track caseItem.id) {
                  <tr class="border-t border-slate-700/50 hover:bg-slate-700/30 transition-colors">
                    <td class="py-3 text-slate-300">{{ formatDate(caseItem.created_at) }}</td>
                    <td class="py-3 text-slate-100">{{ caseItem.email || 'N/A' }}</td>
                    <td class="py-3 text-slate-300 capitalize">{{ caseItem.noticeType || 'N/A' }}</td>
                    <td class="py-3 text-slate-400">{{ caseItem.outputModel || '-' }}</td>
                    <td class="py-3 text-center">
                      <span
                        class="px-2 py-1 rounded-full text-xs border"
                        [class]="getOutputStatusClass(caseItem.outputStatus)"
                      >
                        {{ getOutputStatusLabel(caseItem.outputStatus) }}
                      </span>
                    </td>
                    <td class="py-3 text-right font-medium text-green-400">${{ caseItem.amount || 0 | number:'1.2-2' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Summary Footer -->
          <div class="mt-4 pt-4 border-t border-slate-700 flex items-center justify-between text-sm">
            <span class="text-slate-400">
              Showing {{ supabaseData?.completedCases?.length || 0 }} paid cases
            </span>
            <span class="text-slate-300">
              Total Paid: <span class="font-bold text-green-400">${{ supabaseData?.totalRevenue | number:'1.2-2' }}</span>
            </span>
          </div>
        </div>
      </section>
    }
  }
</div>
